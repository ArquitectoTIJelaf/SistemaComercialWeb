@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/_LayoutLogin.cshtml";
}

@section styles{
    <style>
        @@media (max-width: 767px) {
            .input-xs {
                height: 26px;
                padding: 2px 5px;
                font-size: 12px;
                line-height: 1.5;
                border-radius: 3px;
            }
        }

        button:disabled {
            background-color: #DFE1FF !important
        }

        button:hover:disabled {
            color: red !important;
            border-color: #FC9898 !important;
        }
    </style>
}

<div id="appVueLogin">
    <form v-on:submit.prevent="confirmUsuario(filtro)" action="@Url.Content("~/login/redirect")" id="frmLogin" class="form-container" autocomplete="off">        
        <div class="form-group m-b-0">
            <div class="separate-in-form">
                <center style="padding-bottom: 20px;">
                    <img width="35%" src="~/wwwroot/plugins/images/owner/venta-comercial.png" />
                </center>
            </div>
            <div class="separate-in-form">
                <v-select v-model="filtro.Sucursal"
                          :id="'cboSucursal'"
                          :options="list.sucursales"
                          :placeholder="'Sucursal'"
                          ref="select">
                    <span slot="no-options" class="text-danger">No hay resultados</span>
                </v-select>
            </div>
            <div class="separate-in-form">
                <v-select v-model="filtro.PuntoVenta"
                          :id="'cboPuntoVenta'"
                          :options="list.puntosventa"
                          :placeholder="'Punto de Venta'"
                          ref="select">
                    <span slot="no-options" class="text-danger">No hay resultados</span>
                </v-select>
            </div>
            <div class="separate-in-form">
                <v-select v-model="filtro.Nombre"
                          :id="'cboUsuario'"
                          :options="list.usuarios"
                          :placeholder="'Usuario'"
                          ref="select">
                    <span slot="no-options" class="text-danger">No hay resultados</span>
                </v-select>
            </div>
            <div class="separate-in-form">
                <input v-model="filtro.Clave"
                       type="password" 
                       name="txtClave" 
                       class="form-control input-sm" 
                       placeholder="Clave" />
            </div>
            <div class="separate-in-form">
                <button type="submit" class="btn btn-info btn-block">Ing</button>
            </div>
        </div>
    </form>
</div>

@section scripts{
    <script>

        var appVueLogin = new Vue({
            el: '#appVueLogin',
            data: {
                filtro: {
                    Nombre: null,
                    Clave: '',
                    Sucursal: null,
                    PuntoVenta: null
                },
                list: {
                    sucursales: [],
                    puntosventa: [],
                    usuarios: []
                }
            },
            mounted: function () {
                //this.$refs.select.open = true
                this.getSucursales();
                this.$nextTick(() => {
                    $('.vs__selected-options input[type=search]').addClass('input-sm');
                });
            },
            methods: {
                //confirmUsuario: function (filtro) {
                //    APP.rq.axios2.post(APP.base + '/login/post-usuario', filtro)
                //        .then(res => {
                //            if (res.data.mensaje === 'Log success') {
                //                $('#frmLogin').submit();
                //            } else {
                //                APP.msg.warning(res.data.mensaje);
                //            }
                //        }).catch(APP.rq.axios_handler_error_alert);
                //},
                getSucursales: function () {
                    var _this = this;
                    APP.rq.axios2.get(APP.base + '/base/get-oficinas')
                        .then(res => {
                            _this.list.sucursales = res.data;
                        }).catch(APP.rq.axios_handler_error_alert);
                },
                getPuntosVenta: function (Codi_Sucursal) {
                    var _this = this;
                    APP.rq.axios2.get(APP.base + '/base/get-puntosventa', { params: { CodiSucursal: Codi_Sucursal } })
                        .then(res => {
                            _this.list.puntosventa = res.data;
                        }).catch(APP.rq.axios_handler_error_alert);
                },
                getUsuarios: function (_cod) {
                    var _this = this;
                    APP.rq.axios2.get(APP.base + '/base/get-usuarios', { params: { CodiPuntoVenta: _cod } })
                        .then(res => {
                            debugger;
                            _this.list.usuarios = res.data;
                        }).catch(APP.rq.axios_handler_error_alert);
                },
                //isNumber: function (evt) {
                //    evt = evt ? evt : window.event;
                //    var charCode = evt.which ? evt.which : evt.keyCode;
                //    if ((charCode > 31 && (charCode < 48 || charCode > 57))) {
                //        evt.preventDefault();
                //    } else {
                //        return true;
                //    }
                //},
                //onSubmitMethod: function (event) {
                //    var _this = this;
                //    if (event) event.preventDefault();
                //    if (event) event.stopPropagation();
                //    if (_this.filtro.Sucursal === '') {
                //        document.getElementById("txtSucursal").focus();
                //    } else if (_this.filtro.PuntoVenta === '') {
                //        document.getElementById("txtPuntoVenta").focus();
                //    } else if (_this.filtro.Nombre === '') {
                //        document.getElementById("cboUsuario").focus();
                //    } else if (_this.filtro.Clave === '') {
                //        document.getElementById("txtContrasena").focus();
                //    } else {
                //        document.getElementById("btnLogIn").click();
                //    }
                //}
            },
            computed: {
            },
            watch: {
                'filtro.Sucursal': function (newVal, oldVal) {
                    if (newVal) {
                        if (String(newVal.id).replace(/\s/g, '').length > 0) {
                            this.getPuntosVenta(newVal.id);
                        } 
                    } else {
                        this.list.puntosventa = [];
                        this.filtro.PuntoVenta = null;
                        this.list.usuarios = [];
                        this.filtro.Nombre = null;
                        this.filtro.Clave = '';
                    }
                },
                //'filtro.PuntoVenta': function (newVal, oldVal) {
                //    if (String(newVal).replace(/\s/g, '').length > 0) {
                //        this.getUsuarios(newVal);
                //    } else {
                //        this.list.usuarios = [];
                //        this.filtro.Nombre = '';
                //        this.filtro.Clave = '';
                //    }
                //}
            }
        });

    </script>
}
